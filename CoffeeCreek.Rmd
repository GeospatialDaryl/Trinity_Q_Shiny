---
title: "Coffee Creek Flow Matching"
author: "Daryl Van Dyke"
output: html_notebook
---
This is a notebook that looks at the interaction of the discharge gage at Lewiston Dam and Coffee Creek tributatory to the Trinity River.  This pair provides the 'above and below' dam version of the flow records.

The Coffee Creek UGSS gage station (site 11523200) started record on 1957-10-01 (HY1958) and overlaps from then on.  The first three years are pre-dam years, and as such, form the basis of determing lag and scaling parameters to estimate unimpaired flow.
```{r}
library(dplyr)
library(ggplot2)
library(modelr)
library(broom)
library(tidyr)
library(viridis)
library(tidyr)
```


```{r}
d1 <- ymd("1957-10-01")
d2 <- ymd("1958-10-01")
d3 <- ymd("1959-10-01")
d4 <- ymd("1960-10-01")
d5 <- ymd("1961-10-01")

dHY58 <- GetHydroDF(d1, d2)
dHY59 <- GetHydroDF(d2, d3)
dHY60 <- GetHydroDF(d3, d4)
dHY5860 <- GetHydroDF(d1, d4)

Plot_tAllQ_FullFat(d1,d4, boolCCkHydr = TRUE)
```
The three years of overlape (HY58, HY59, and HY1960) present three different water year types defined by the Record of Decision:  Ex.Wet, Normal, and Dry, respectively.

```{r}
Plot_tAllQ_FullFat(d1,d2, boolCCkHydr = T)
```
```{r}
Plot_tAllQ_FullFat(ymd("1959-02-15"), ymd("1959-03-01"), boolCCkHydr = T)
```
It looks like lag is about 1 day.
```{r}
Plot_tAllQ_FullFat(ymd("1959-02-15"), ymd("1959-02-21"), boolCCkHydr = T)
```
```{r}
Plot_tAllQ_FullFat(ymd("1959-12-20"), ymd("1960-01-1"), boolCCkHydr = T)
```
One full day of lag again
```{r}
Plot_tAllQ_FullFat(ymd("1959-02-15"), ymd("1959-03-01"), boolCCkHydr = T)
```
```{r}
dHY5860$YMD -> ymd5860
ccq5860 <- dHY5860$CoffeeCreek.Q
# coffee ck is 1 day ahead of lewiston
ymd5860CCk <- ymd5860 + 1         #  slide dates forward 1 day
ymd5860CCk <- as.data.frame(ymd5860CCk)
ccq5860 <- as.data.frame(ccq5860)

dlag <- as.data.frame(cbind(ymd5860CCk,ccq5860)) # make dlag
delaggedQ <- as_tibble(dlag)
rm(dlag)
rm(ccq5860)
rm(ymd5860)
rm(ymd5860CCk)
names(delaggedQ) <- c("YMD", "CCk.Q.delag.p1day")

# delaggedQ is 1958-60 Coffee Ck flows

pLag <- qplot(delaggedQ$YMD,delaggedQ$CCk.Q.delag.p1day , geom="line" )

plot(pLag)
```

```{r}
p1 <- Plot_tAllQ_FullFat(ymd("1959-02-15"), ymd("1959-03-01"), boolCCkHydr = T)
```

```{r}
stDate <- min(p1$data$YMD)
enDate <- max(p1$data$YMD)

delagSlice <- filter(delaggedQ, YMD >= stDate )
delagSlice <- filter(delagSlice, YMD <= enDate )

p2 <- p1 + geom_line( aes(delagSlice$YMD, delagSlice$CCk.Q.delag.p1day), color = "red"
  )
hLineY <- ymd("1959-02-17", origin = orig)
p2 <- p2 + geom_vline(xintercept=hLineY , color = "blue") 
plot(p2)
```
```{r}

startDateOverlap <- min(delaggedQ$YMD)
endDateOverlap <- max(delaggedQ$YMD)

tAllQSlice <- filter(tAllQ, YMD >= startDateOverlap )
tAllQSlice <- filter(tAllQSlice, YMD <= endDateOverlap )

plot(log(delaggedQ$CCk.Q.delag.p1day),log(tAllQSlice$Q)) -> plotLL

```

```{r}
loggedQvQ <- as_tibble(cbind(log(tAllQSlice$Q),log(delaggedQ$CCk.Q.delag.p1day)))
names(loggedQvQ) <- c("logTriQ","logCCkQ")
#llScaling <- lm(log(tAllQSlice$Q)~log(delaggedQ$CCk.Q.delag.p1day))
llScaling <- lm(loggedQvQ$logTriQ~loggedQvQ$logCCkQ)
Scaling <- lm(tAllQSlice$Q~delaggedQ$CCk.Q.delag.p1day)
plot(log(delaggedQ$CCk.Q.delag.p1day),log(tAllQSlice$Q))
abline(llScaling)
```


Now the stats


```{r}
rmse(llScaling,loggedQvQ)
rsquare(llScaling,loggedQvQ)
mae(llScaling,loggedQvQ)
qae(llScaling,loggedQvQ)
```
 
```{r}
set.seed(1986)
glance(llScaling)

tAllQPred <- tAllQ
tAllQPred$logCCkQ <- log(tAllQPred$CoffeeCreek.Q) 

tAllQPred <- drop_na(tAllQPred)

stDate <- startDateOverlap
enDate <- endDateOverlap

tAllQPred  <- filter(tAllQPred, YMD >= stDate )
tAllQPred <- filter(tAllQPred, YMD <= enDate )
dim(tAllQPred)
tAllQPred$CCk.linear.pred <- tAllQPred$CoffeeCreek.Q
tAllQPred %>%
  add_predictions( model = llScaling) -> tAllQPred

tAllQPred$CCk.Pred <- exp(tAllQPred$pred)

Plot_tAllQ_FullFat(d1,d4, boolCCkHydr = TRUE) -> comparePlot
comparePlot + geom_line( aes(tAllQPred$YMD, tAllQPred$CCk.Pred), color = "red" ) + xlim(d1,d2)

```
now compare to the Spreadsheet method (Q_undammed = Q_coffeeCk * 4.822147651 )

This is calculated by the ratios of the upstream watersheds for CCk and Trinity River above Lewiston.
```{r}
TrinityBasin_abvLew_mi2 <- 718.5
CoffeeCkWshed_mi2 <- 149

xlScaler <- TrinityBasin_abvLew_mi2/CoffeeCkWshed_mi2
tAllQPred$CCk.Q.xlScaler <- tAllQPred$Q*xlScaler

comparePlot + geom_line( aes(tAllQPred$YMD, tAllQPred$CCk.Pred), color = "red" )-> comparePlot2
comparePlot2 + geom_line( aes(tAllQPred$YMD, tAllQPred$CCk.Q.xlScaler),
                          color = "blue" ) + xlim(d1,d2) + theme(legend.justification = "bottom")

```
That's the extremely wet year.
```{r}
comparePlot2 + geom_line( aes(tAllQPred$YMD, tAllQPred$CCk.Q.xlScaler),
                          color = "blue" ) + xlim(d2,d3) + theme(legend.justification = "bottom")
```
Normal
```{r}
comparePlot2 + geom_line( aes(tAllQPred$YMD, tAllQPred$CCk.Q.xlScaler),
                          color = "blue" ) + xlim(d2,d3) + theme(legend.justification = "bottom")
```
Dry.

The scaler method is over-estimating pretty significantly.

Finally, let's look at loess smoothing for the predictor:
```{r}
#loggedQvQ <- as_tibble(cbind(log(tAllQSlice$Q),log(delaggedQ$CCk.Q.delag.p1day)))
#names(loggedQvQ) <- c("logTriQ","logCCkQ")
#llScaling <- lm(log(tAllQSlice$Q)~log(delaggedQ$CCk.Q.delag.p1day))
loess10Scaling <- loess(loggedQvQ$logTriQ~loggedQvQ$logCCkQ, span = 0.10, se = TRUE)
loess25Scaling <- loess(loggedQvQ$logTriQ~loggedQvQ$logCCkQ, span = 0.25, se = TRUE)
loess50Scaling <- loess(loggedQvQ$logTriQ~loggedQvQ$logCCkQ, span = 0.50, se = TRUE)

gloess <- ggplot(loggedQvQ,aes(x=loggedQvQ$logCCkQ,y=loggedQvQ$logTriQ ) ) +
  geom_jitter() +
  #geom_smooth( method = "lm", color = viridis(1, begin = .1)  , se = FALSE) +
  #geom_smooth( method = "loess",    color = viridis(1, begin = 0.6), se = FALSE,
  #             linetype = "dashed") 
  geom_smooth( method = "lm", color = viridis(1, begin = .1)  , se = FALSE) +
  geom_smooth( method = "loess",    color = viridis(1, begin = 0.6), se = FALSE,
               linetype = "dashed") +
  theme(legend.position = "right")
plot(gloess)

```
This is what we wanted - better agreement in the high end discharge.  This should significantly improve the predictions.

Not, also the better agreement in `exp(4.25)` CFS to `exp(7)` CFS.

```{r}
summary(loess10Scaling)
```
```{r}
summary(loess25Scaling)
```

```{r}
summary(loess50Scaling)
```
Now set up <models>.predict
```{r}
#https://stackoverflow.com/questions/44865508/using-ggplot2-to-plot-an-already-existing-linear-model

# create and summarise model  - above

# add 'fit', 'lwr', and 'upr' columns to dataframe
loess10Scaling.predict <- cbind(loggedQvQ,predict(loess10Scaling,
                                                  interval= "confidence",
                                                  level = 0.95) )

loess10Scaling.predict$TriQ <- exp(loess10Scaling.predict$logTriQ)
loess10Scaling.predict$CCkQ <- exp(loess10Scaling.predict$logCCkQ)
l10pred <- loess10Scaling.predict
#l10pred$lwr <- l10pred[,3] - qt(0.975, loess10Scaling$df)*loess10Scaling$se


loess25Scaling.predict <- cbind(loggedQvQ,predict(loess25Scaling,
                                                  interval= "confidence") )

loess25Scaling.predict$TriQ <- exp(loess25Scaling.predict$logTriQ)
loess25Scaling.predict$CCkQ <- exp(loess25Scaling.predict$logCCkQ)

loess50Scaling.predict <- cbind(loggedQvQ,predict(loess50Scaling,
                                                  interval= "confidence") )

loess50Scaling.predict$TriQ <- exp(loess50Scaling.predict$logTriQ)
loess50Scaling.predict$CCkQ <- exp(loess50Scaling.predict$logCCkQ)

# plot the points (actual observations), regression line, and confidence interval
#p10 <- ggplot(loess10Scaling.predict, aes(CCkQ, TriQ))
#p10 <- p10 + geom_point()
#p10 <- p10 + geom_line(aes(CCkQ, fit))
#p10 <- p10 + geom_ribbon(aes(ymin=lwr,ymax=upr), alpha=0.3)
#p10

calcSSE <- function(x){
  loessMod <- try(loess(loggedQvQ$logTriQ~loggedQvQ$logCCkQ, span=x), silent=F)
  res <- try(loessMod$residuals, silent=T)
  if(class(res)!="try-error"){
    if((sum(res, na.rm=T) > 0)){
      sse <- sum(res^2)  
    }
  }else{
    sse <- 99999
  }
  return(sse)
}
optim(par=c(0.5), calcSSE, method="SANN")

dfLoessResiduals <- data.frame(Span=character(),
                               Residual=double())
seqSpan <- seq(0.01,1,0.01)

cbind(seqSpan,seqSpan) -> tblSpans
dTblSpans <- as.data.frame(tblSpans)
names(dTblSpans) <- c("span","residual")
for(i in seq(1,100)){
  loessMod <- loess(loggedQvQ$logTriQ~loggedQvQ$logCCkQ, span=dTblSpans[i,1])
  dTblSpans[i,2] <- sum(abs(loessMod$residuals))
}
plot(dTblSpans)
```
```{r}
plot(loggedQvQ$logTriQ,x=loggedQvQ$logCCkQ, type="p", main="Loess Smoothing and Prediction")
lines(loess10Scaling.predict, x=loggedQvQ$logCCkQ, col="red")
lines(loess25Scaling.predict, x=loggedQvQ$logCCkQ, col="green")
lines(loess50Scaling.predict, x=loggedQvQ$logCCkQ, col="blue")
```

Assemble predicted overlap for final comparison.

```{r}
predict( loess50Scaling,tAllQPred$logCCkQ) -> tAllQPred$logTriQ.Pred.Loess50
predict( loess25Scaling,tAllQPred$logCCkQ) -> tAllQPred$logTriQ.Pred.Loess25
predict( loess10Scaling,tAllQPred$logCCkQ) -> tAllQPred$logTriQ.Pred.Loess10

tAllQPred$TriQ.Pred.Loess10 <- exp(tAllQPred$logTriQ.Pred.Loess10)
tAllQPred$TriQ.Pred.Loess25 <- exp(tAllQPred$logTriQ.Pred.Loess25)
tAllQPred$TriQ.Pred.Loess50 <- exp(tAllQPred$logTriQ.Pred.Loess50)


comparePlot + geom_line( aes(tAllQPred$YMD, tAllQPred$TriQ.Pred.Loess10), color = "red" )-> comparePlot2

comparePlot2
```
black is actual TriQ, Purple is actual Cck, red is Loess10 Prediction



```{r}
comparePlot2 + geom_line( aes(tAllQPred$YMD, tAllQPred$CCk.Q.xlScaler),
                          color = "blue" ) +
  xlim(d1,d2) + 
  theme(legend.justification = "bottom") -> comparePlot3
comparePlot3
```
The blue is basin scaline (~4.8), black is actual TriQ, Purple is actual Cck, red is Loess10 Prediction
```{r}

tAllQPred[, c(1,2,6,14,15,16,17)] -> reshapeTAllQPred

reshapeTAllQPred[,c(1,2)] -> rshpTrinityQ
reshapeTAllQPred[,c(1,3)] -> rshpCoffeeCkQ
reshapeTAllQPred[,c(1,4)] -> rshpTriQ.Pred.Loess10
reshapeTAllQPred[,c(1,5)] -> rshpTriQ.Pred.Loess25
reshapeTAllQPred[,c(1,6)] -> rshpTriQ.Pred.Loess50
reshapeTAllQPred[,c(1,7)] -> rshpTriQ.Pred.Linear

rshpTrinityQ$model    <- "TrinityObs"
rshpCoffeeCkQ$model   <- "CoffeeCkObs" 
rshpTriQ.Pred.Loess10$model <- "TrinityPredLoess10"
rshpTriQ.Pred.Loess25$model <- "TrinityPredLoess25"
rshpTriQ.Pred.Loess50$model <- "TrinityPredLoess50"
rshpTriQ.Pred.Linear$model   <- "TrinityPredLinear"

names(rshpCoffeeCkQ) <- c("YMD", "Q", "model")
#rshpTriQ.Pred.Loess10
names(rshpTriQ.Pred.Loess10) <- c("YMD", "Q", "model")
#rshpTriQ.Pred.Loess25
names(rshpTriQ.Pred.Loess25) <- c("YMD", "Q", "model")
#rshpTriQ.Pred.Loess50
names(rshpTriQ.Pred.Loess50) <- c("YMD", "Q", "model")
#rshpTriQ.Pred.Linear
names(rshpTriQ.Pred.Linear) <- c("YMD", "Q", "model")

rshpTAllQPred <- bind_rows(rshpTrinityQ, rshpCoffeeCkQ, rshpTriQ.Pred.Linear,
                           rshpTriQ.Pred.Loess10,rshpTriQ.Pred.Loess25,
                           rshpTriQ.Pred.Loess50)


rshpTAllQPred %>% group_by(model) %>%
  ggplot(aes(YMD,Q, color = model)) -> compPlot
compPlot + geom_line()
#compPlot <- ggplot(tAllQPred, aes(YMD, Q) )
#compPlot + geom_line() + geom_line()
compPlot
```

